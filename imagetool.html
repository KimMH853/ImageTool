<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.2.4/fabric.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    
    <style>
        
        /* canvas {
            
            
            width: 500;
            height: 500;
        } */
        .clicked {
            color: gold;
        }  
        .canvas-container { 
            margin:0 auto ;
        } 
        .button-container { 
            text-align: center;   
            margin: 10px;                 
        } 
        .btn {
            display :inline-block;
            
        }
    </style>
</head>
<body onload="draw();">
    <button type="button" onclick="move();" class="button1">이동</button>
    <button type="button" onclick="rotation();">회전</button>
    <button type="button" onclick="size();" class="button1">사이즈변경</button>
    <button type="button" onclick="crop();">crop</button>
    <button type="button" onclick="crop1();">확인</button>
    <button type="button">제출</button>
    <canvas id="c" width=600 height=600 ></canvas>

    <script>
        var canvas = new fabric.Canvas('c'); 
        canvas.backgroundColor = 'rgba(255,255,255,1)';
        let i =0;
       function draw(){
            fabric.Image.fromURL('https://images.unsplash.com/photo-1603348929190-0257ea827c97?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80', function(oImg) {
                oImg.scale(0.4);
                // oImg.setWidth(200);
                // oImg.setHeight(200);
                oImg.set({ left: 20, top: 50, selectable: false });
                canvas.add(oImg);
            }, { crossOrigin: 'Anonymous' });
            
        }

        function move(){
             const clickedClass = "clicked";
            if(event.target.classList.contains(clickedClass)) {
                console.log("끄기");
                canvas.skipTargetFind = true; // <-this cause object could be selectable!
                canvas.item(0).selectable = false;
                canvas.renderAll();
                
                //canvas.selectable = false;
                //canvas.set("selectable", false);
                event.target.classList.remove("clicked");
                //oImg.set({ left: 20, top: 50, selectable: false });
                //canvas.item(0).set({ selection: false })
                console.log(canvas.item(0));
                // canvas.forEachObject(function (object) {
                //     object.selectable = false;
                // });
                
                canvas.item(0).hasControls = canvas.item(0).hasBorders = true;
            } else {
                event.target.classList.add(clickedClass);
                console.log("켜기");
                canvas.skipTargetFind = false;
                canvas.item(0).selectable = true;
                canvas.item(0).hasControls = canvas.item(0).hasBorders = false;

                canvas.on({
                    'mouse:down': function (e) {
                        if (e.target) {
                            e.target.opacity = 0.5;

                            canvas.renderAll();
                        }
                    },
                    'mouse:up': function (e) {
                        if (e.target) {
                            e.target.opacity = 1;
                            canvas.renderAll();
                        }
                    },
                    'object:moved': function (e) {
                        e.target.opacity = 0.5;
                    },
                    'object:modified': function (e) {
                        e.target.opacity = 1;
                    },
                    'after:render': function () {
                        const item = canvas.item(0)
                        if (!item.isOnScreen()) {
                            item.setCoords()
                        }
                    }
                });
            }
            
            //this.__canvases.push(canvas);
        }

        function rotation() {
            event.target.classList.add("clicked");
            
            canvas.item(0).selectable = true;
            canvas.setActiveObject(canvas.item(0));
            canvas.item(0).setControlsVisibility({
                'bl': false,
                'br': false,
                'mb': false,
                'ml': false,
                'mr': false,
                'mt': false,
                'tl': false,
                'tr': false,
            });
            canvas.item(0).lockMovementX = true;
            canvas.item(0).lockMovementY = true;
            canvas.renderAll();

        }
        function size() {
            event.target.classList.add("clicked");

            canvas.item(0).selectable = true;
            canvas.item(0).setControlVisible('mtr', false);
            canvas.setActiveObject(canvas.item(0));
            canvas.item(0).lockMovementX = true;
            canvas.item(0).lockMovementY = true;
            canvas.renderAll();
        }
        var selectionRect;
        function crop() {
            event.target.classList.add("clicked");

            //canvas.item(0).selectable = true;

            selectionRect = new fabric.Rect({
                fill: 'rgba(0,0,0,0.3)',
                originX: 'left',
                originY: 'top',
                stroke: 'black',
                opacity: 1,
                width: canvas.item(0).width,
                height: canvas.item(0).height,
                hasRotatingPoint: false,
                transparentCorners: false,
                cornerColor: 'white',
                cornerStrokeColor: 'black',
                borderColor: 'black',
            });

            selectionRect.scaleToWidth(300);
            canvas.centerObject(selectionRect);
            selectionRect.visible = true;
            canvas.add(selectionRect);

            //canvas.preserveObjectStacking = true;
            canvas.setActiveObject(selectionRect);
        }
        function crop1() {
            //     let rect = new fabric.Rect({
            //     left: selectionRect.left,
            //     top: selectionRect.top,
            //     width: selectionRect.getScaledWidth(),
            //     height: selectionRect.getScaledHeight(),
            //     absolutePositioned: true
            // });

            // canvas.item(0).clipPath = rect;

            // canvas.remove(selectionRect);

            // canvas.renderAll();

            // create mask rectabgle for crop
            let rect = new fabric.Rect({
                left: selectionRect.left,
                top: selectionRect.top,
                width: selectionRect.getScaledWidth(),
                height: selectionRect.getScaledHeight(),
                absolutePositioned: true,
            });

            // add to the current image clicpPath property
            canvas.item(0).clipPath = rect;

            // remove the mask layer
            canvas.remove(selectionRect);

            // init new image instance
            var cropped = new Image();
            //cropped.crossOrigin = 'Anonymous';
            
            // set src value of canvas croped area as toDataURL
            cropped.src = canvas.toDataURL({
                left: rect.left,
                top: rect.top,
                width: rect.width,
                height: rect.height,
            });
           
            // after onload clear the canvas and add cropped image to the canvas
            cropped.onload = function () {
                //canvas.item(0).clear();
                canvas.remove(canvas.item(0));
                image = new fabric.Image(cropped);
                image.left = rect.left;
                image.top = rect.top;
                image.setCoords();
                canvas.add(image);
                canvas.renderAll();
            };    

            };

        //setControlsVisibility(옵션 선택) → { fabric.Object }
        // perPixelTargetFind: 부울
        //     'true'로 설정하면 경계 상자에 따르지 않고 픽셀 단위로 캔버스에서 객체를 "발견"합니다.
    </script>
</body>
</html>